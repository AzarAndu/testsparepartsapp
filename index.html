<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spare Parts Data</title>
<style>
/* === Original + small toolbar styles === */
body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background: #f5f6fa;
    transition: background 0.3s ease, color 0.3s ease;
}
body.dark { background: #2c3e50; color: #ecf0f1; }
h2 {
    margin-bottom: 15px;
    color: #333;
    transition: color 0.3s ease;
}
body.dark h2 { color: #ecf0f1; }
input {
    padding: 10px;
    width: 350px;
    max-width: 100%;
    border: 1px solid #aaa;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 15px;
    box-sizing: border-box;
    transition: box-shadow 0.3s ease;
}
input:focus, input:active {
    box-shadow: 0 0 15px rgba(0,123,255,0.5);
    outline: none;
}
.compact input { width: 280px; font-size: 14px; }
#status { color: #666; font-style: italic; margin-bottom: 10px; }
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
body.dark table { background: #34495e; }
th {
    background: #e6e9f0;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    transition: background 0.3s ease;
}
body.dark th { background: #2c3e50; color: #ecf0f1; border-bottom-color: #555; }
td {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.compact td, .compact th { padding: 6px; font-size: 13px; }
tr:hover, tr:active {
    background: #f2f4f7;
}
body.dark tr:hover, body.dark tr:active { background: #3d566e; }
.pagination {
    margin-top: 20px;
}
.pagination button {
    padding: 8px 15px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 5px;
    transition: background 0.2s ease;
    touch-action: manipulation;
}
.pagination button:hover {
    background: #0056b3;
}
.pagination button:disabled {
    background: #aaa;
    cursor: not-allowed;
}
#page-info {
    margin: 0 10px;
    font-weight: bold;
}
#jumpPage {
    padding: 8px;
    width: 120px;
    max-width: 100%;
    border: 1px solid #aaa;
    border-radius: 5px;
    box-sizing: border-box;
    transition: box-shadow 0.3s ease;
}
#jumpPage:focus, #jumpPage:active { box-shadow: 0 0 15px rgba(0,123,255,0.5); }
.compact #jumpPage { width: 100px; }

/* Topbar */
.topbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 6px; }
.btn-primary { background: #007bff; color: white; }
.btn-ghost { background: transparent; border: 1px solid #007bff; color: #007bff; }

/* Toggles */
.toggles { display: flex; gap: 15px; }
.toggle { position: relative; display: inline-block; width: 50px; height: 26px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background: #ccc; transition: 0.3s; border-radius: 26px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
  background: white; transition: 0.3s; border-radius: 50%; }
input:checked + .slider { background: #007bff; }
input:checked + .slider:before { transform: translateX(24px); }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  display: none; align-items: center; justify-content: center; z-index: 999; }
.modal { background: white; padding: 16px; border-radius: 8px; width: 720px; max-width: 95%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
#qr-reader { width:100%; min-height:260px; }

/* Responsive */
@media (max-width: 768px) {
    input, #jumpPage { width: 100%; padding: 12px; font-size: 16px; }
    table { overflow-x: auto; display: block; white-space: nowrap; }
}
</style>
</head>
<body>

<div id="status">Loading data...</div>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button class="btn btn-primary" id="btn-scan">ðŸ“· Scan (QR / Barcode)</button>
  <button class="btn" id="btn-refresh">â†» Refresh</button>

  <div style="flex:1"></div>

  <div class="toggles">
    <label class="toggle">
        <input type="checkbox" id="darkToggle" onchange="toggleDark()">
        <span class="slider"></span>
    </label>
    <label class="toggle">
        <input type="checkbox" id="compactToggle" onchange="toggleCompact()">
        <span class="slider"></span>
    </label>
  </div>
</div>

<input type="text" id="search" placeholder="Search part / description / category / qty">

<table>
    <thead>
        <tr>
            <th>S.No</th>
            <th>Item No</th>
            <th>Part No</th>
            <th>Description</th>
            <th>Category</th>
            <th>Qty</th>
        </tr>
    </thead>
    <tbody id="table-body"></tbody>
</table>

<div class="pagination">
    <button id="prev-page">Prev</button>
    <span id="page-info"></span>
    <button id="next-page">Next</button>
</div>

<br>

<input type="number" id="jumpPage" placeholder="Go to page">
<button onclick="jumpToPage()">Go</button>

<!-- QR / Barcode Scanner Modal -->
<div id="qr-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Scanner (QR + Barcode)</h3>
    <div id="qr-reader"></div>
    <div style="text-align:right; margin-top:8px;">
      <button class="btn" id="qr-close">Close</button>
    </div>
  </div>
</div>

<script>
let items = [];
let currentPage = 1;
const perPage = 50;
let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';
const statusEl = document.getElementById('status');
const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";

// Mock data fallback
const mockData = [
    { "item no": "0720", "part no": "0720", "description": "0720 AC CONDENSOR NIS PICK UP 02-09", "category": "AC PARTS ITEMS", "qty": "0" },
    { "item no": "4060-ZC026", "part no": "44060-ZC026/SP1512", "description": "44060-ZC026 BRAKE PAD RR NIS ARMADA 07-", "category": "BRAKE PAD", "qty": "25.5" },
];

if (isDark) document.body.classList.add('dark');
if (isCompact) document.body.classList.add('compact');
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

function toggleDark(){isDark=!isDark;document.body.classList.toggle('dark',isDark);
localStorage.setItem('darkMode',isDark);}
function toggleCompact(){isCompact=!isCompact;document.body.classList.toggle('compact',isCompact);
localStorage.setItem('compactMode',isCompact);}

function cleanKeys(row){let fixed={};for(let key in row){
fixed[key.trim()] = (row[key]+"").trim();}return fixed;}

function display(list){
    const tbody=document.getElementById("table-body");tbody.innerHTML="";
    const startIndex=(currentPage-1)*perPage;
    const headers=['S.No','Item No','Part No','Description','Category','Qty'];
    for(let index=0;index<list.length;index++){
        const row=list[index];
        let rowHtml="<tr>";
        rowHtml+=`<td data-label="${headers[0]}">${startIndex+index+1}</td>`;
        rowHtml+=`<td data-label="${headers[1]}">${row["item no"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[2]}">${row["part no"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[3]}">${row["description"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[4]}">${row["category"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[5]}">${row["qty"]||""}</td>`;
        rowHtml+="</tr>";
        tbody.innerHTML+=rowHtml;
    }
}

function render(){
    let q=document.getElementById("search").value.toLowerCase();
    let keywords=q.split(" ").filter(k=>k.trim()!=="");
    let filtered=items.filter(row=>{
        let text=( (row["item no"]||"")+" "+
                   (row["part no"]||"")+" "+
                   (row["description"]||"")+" "+
                   (row["category"]||"")+" "+
                   (row["qty"]||"") ).toLowerCase();
        return keywords.every(word=>text.includes(word));
    });

    let totalPages=Math.max(1,Math.ceil(filtered.length/perPage));
    if(currentPage>totalPages) currentPage=totalPages;

    let start=(currentPage-1)*perPage;
    display(filtered.slice(start,start+perPage));

    document.getElementById("page-info").innerText=
        "Page "+currentPage+" of "+totalPages;

    document.getElementById("prev-page").disabled=currentPage===1;
    document.getElementById("next-page").disabled=currentPage===totalPages;
}

document.getElementById("search").addEventListener("input",()=>{currentPage=1;render();});

document.getElementById("prev-page").addEventListener("click",()=>{if(currentPage>1)currentPage--;render();});
document.getElementById("next-page").addEventListener("click",()=>{currentPage++;render();});

function jumpToPage(){
 let p=parseInt(document.getElementById("jumpPage").value);
 if(!isNaN(p)&&p>0){currentPage=p;render();}
}

function loadData(){
    statusEl.innerText="Fetching from SheetDB...";
    fetch(SHEETDB_BASE)
    .then(res=>res.json())
    .then(data=>{
        items=data.map(cleanKeys);
        statusEl.innerText="Loaded "+items.length+" records.";
        render();
    })
    .catch(err=>{
        statusEl.innerText="Offline mode: Using sample data.";
        items=mockData;render();
    });
}
loadData();

document.getElementById('btn-refresh').addEventListener('click',loadData);

/* ========= FIXED LOCAL SCANNER LOADER ========= */

let html5QrcodeLoaded=false;
let qrScanner=null;

function loadHtml5QrcodeScript(){
  return new Promise((resolve,reject)=>{
    if(html5QrcodeLoaded) return resolve();

    const s=document.createElement("script");
    s.src="html5-qrcode.min.js";   // LOCAL FIX âœ”
    s.onload=()=>{html5QrcodeLoaded=true;resolve();};
    s.onerror=()=>reject("Failed to load local scanner library.");
    document.head.appendChild(s);
  });
}

const qrBackdrop=document.getElementById("qr-backdrop");
const qrReader=document.getElementById("qr-reader");

document.getElementById("btn-scan").addEventListener("click",openQR);
document.getElementById("qr-close").addEventListener("click",closeQR);

async function openQR(){
  qrBackdrop.style.display="flex";
  try{
    await loadHtml5QrcodeScript();
    qrReader.innerHTML="";
    qrScanner=new Html5Qrcode("qr-reader");

    const config={
      fps:10,qrbox:250,
      formatsToSupport:[
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39
      ]
    };

    qrScanner.start(
      {facingMode:"environment"},
      config,
      message=>{
        document.getElementById("search").value=message;
        currentPage=1;render();
      },
      error=>{}
    );
  }catch(e){
    alert("Scanner error: "+e);
    qrBackdrop.style.display="none";
  }
}

function closeQR(){
  qrBackdrop.style.display="none";
  if(qrScanner){
    qrScanner.stop().then(()=>qrScanner.clear()).catch(()=>{});
    qrScanner=null;
  }
}
</script>
</body>
</html>