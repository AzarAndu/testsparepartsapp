<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spare Parts Data</title>
<style>
/* === Original + small toolbar styles === */
body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background: #f5f6fa;
    transition: background 0.3s ease, color 0.3s ease;
}
body.dark { background: #2c3e50; color: #ecf0f1; }
h2 {
    margin-bottom: 15px;
    color: #333;
    transition: color 0.3s ease;
}
body.dark h2 { color: #ecf0f1; }
input {
    padding: 10px;
    width: 350px;
    max-width: 100%;
    border: 1px solid #aaa;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 15px;
    box-sizing: border-box;
    transition: box-shadow 0.3s ease;
}
input:focus, input:active {
    box-shadow: 0 0 15px rgba(0,123,255,0.5);
    outline: none;
}
.compact input { width: 280px; font-size: 14px; }
#status { color: #666; font-style: italic; margin-bottom: 10px; }
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
body.dark table { background: #34495e; }
th {
    background: #e6e9f0;
    padding: 10px;
    border-bottom: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    transition: background 0.3s ease;
}
body.dark th { background: #2c3e50; color: #ecf0f1; border-bottom-color: #555; }
td {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.compact td, .compact th { padding: 6px; font-size: 13px; }
tr:hover, tr:active {
    background: #f2f4f7;
}
body.dark tr:hover, body.dark tr:active { background: #3d566e; }
.pagination {
    margin-top: 20px;
}
.pagination button {
    padding: 8px 15px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    margin-right: 5px;
    transition: background 0.2s ease;
    touch-action: manipulation;
}
.pagination button:hover {
    background: #0056b3;
}
.pagination button:disabled {
    background: #aaa;
    cursor: not-allowed;
}
#page-info {
    margin: 0 10px;
    font-weight: bold;
}
#jumpPage {
    padding: 8px;
    width: 120px;
    max-width: 100%;
    border: 1px solid #aaa;
    border-radius: 5px;
    box-sizing: border-box;
    transition: box-shadow 0.3s ease;
}
#jumpPage:focus, #jumpPage:active { box-shadow: 0 0 15px rgba(0,123,255,0.5); }
.compact #jumpPage { width: 100px; }

/* Topbar */
.topbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
.btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 6px; }
.btn-primary { background: #007bff; color: white; }
.btn-ghost { background: transparent; border: 1px solid #007bff; color: #007bff; }

/* Toggles */
.toggles { display: flex; gap: 15px; }
.toggle { position: relative; display: inline-block; width: 50px; height: 26px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background: #ccc; transition: 0.3s; border-radius: 26px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
  background: white; transition: 0.3s; border-radius: 50%; }
input:checked + .slider { background: #007bff; }
input:checked + .slider:before { transform: translateX(24px); }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45);
  display: none; align-items: center; justify-content: center; z-index: 999; }
.modal { background: white; padding: 16px; border-radius: 8px; width: 720px; max-width: 95%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
#qr-reader { width:100%; min-height:260px; }

/* Responsive */
@media (max-width: 768px) {
    input, #jumpPage { width: 100%; padding: 12px; font-size: 16px; }
    table { overflow-x: auto; display: block; white-space: nowrap; }
}
</style>
</head>
<body>

<div id="status">Loading data...</div>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button class="btn btn-primary" id="btn-scan">ðŸ“· Scan (QR / Barcode)</button>
  <button class="btn" id="btn-refresh">â†» Refresh</button>

  <div style="flex:1"></div>

  <div class="toggles">
    <label class="toggle">
        <input type="checkbox" id="darkToggle" onchange="toggleDark()">
        <span class="slider"></span>
    </label>
    <label class="toggle">
        <input type="checkbox" id="compactToggle" onchange="toggleCompact()">
        <span class="slider"></span>
    </label>
  </div>
</div>

<input type="text" id="search" placeholder="Search part / description / category / qty">

<table>
    <thead>
        <tr>
            <th>S.No</th>
            <th>Item No</th>
            <th>Part No</th>
            <th>Description</th>
            <th>Category</th>
            <th>Qty</th>
        </tr>
    </thead>
    <tbody id="table-body"></tbody>
</table>

<div class="pagination">
    <button id="prev-page">Prev</button>
    <span id="page-info"></span>
    <button id="next-page">Next</button>
</div>

<br>

<input type="number" id="jumpPage" placeholder="Go to page">
<button onclick="jumpToPage()">Go</button>

<!-- QR / Barcode Scanner Modal -->
<div id="qr-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Scanner modal">
    <h3 style="color: #999;">Scanner (QR + Barcode)</h3>
    <div id="qr-reader"></div>
    <div style="text-align:right; margin-top:8px;">
      <button class="btn" id="qr-close">Close</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   ORIGINAL APP LOGIC (unchanged)
   =========================== */

let items = [];
let currentPage = 1;
const perPage = 50;
let isDark = localStorage.getItem('darkMode') === 'true';
let isCompact = localStorage.getItem('compactMode') === 'true';
const statusEl = document.getElementById('status');
const SHEETDB_BASE = "https://sheetdb.io/api/v1/bykhl1ncapip9";

// Mock data fallback
const mockData = [
    { "item no": "0720", "part no": "0720", "description": "0720 AC CONDENSOR NIS PICK UP 02-09", "category": "AC PARTS ITEMS", "qty": "0" },
    { "item no": "4060-ZC026", "part no": "44060-ZC026/SP1512", "description": "44060-ZC026 BRAKE PAD RR NIS ARMADA 07-", "category": "BRAKE PAD", "qty": "25.5" },
];

if (isDark) document.body.classList.add('dark');
if (isCompact) document.body.classList.add('compact');
document.getElementById('darkToggle').checked = isDark;
document.getElementById('compactToggle').checked = isCompact;

function toggleDark(){isDark=!isDark;document.body.classList.toggle('dark',isDark);
localStorage.setItem('darkMode',isDark);}
function toggleCompact(){isCompact=!isCompact;document.body.classList.toggle('compact',isCompact);
localStorage.setItem('compactMode',isCompact);}

function cleanKeys(row){
    let fixed={};
    for(let key in row){
        fixed[key.trim()] = (row[key]+"").trim();
    }
    return fixed;
}

function display(list){
    const tbody=document.getElementById("table-body");
    tbody.innerHTML="";
    const startIndex=(currentPage-1)*perPage;
    const headers=['S.No','Item No','Part No','Description','Category','Qty'];

    for(let index=0; index<list.length; index++){
        const row=list[index];
        let rowHtml="<tr>";
        rowHtml+=`<td data-label="${headers[0]}">${startIndex+index+1}</td>`;
        rowHtml+=`<td data-label="${headers[1]}">${row["item no"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[2]}">${row["part no"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[3]}">${row["description"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[4]}">${row["category"]||""}</td>`;
        rowHtml+=`<td data-label="${headers[5]}">${row["qty"]||""}</td>`;
        rowHtml+="</tr>";
        tbody.innerHTML+=rowHtml;
    }
}

function render(){
    let q=document.getElementById("search").value.toLowerCase();
    let keywords=q.split(" ").filter(k=>k.trim()!=="");
    let filtered=items.filter(row=>{
        let text=( (row["item no"]||"")+" "+
                   (row["part no"]||"")+" "+
                   (row["description"]||"")+" "+
                   (row["category"]||"")+" "+
                   (row["qty"]||"") ).toLowerCase();
        return keywords.every(word=>text.includes(word));
    });

    let totalPages=Math.max(1,Math.ceil(filtered.length/perPage));
    if(currentPage>totalPages) currentPage=totalPages;

    let start=(currentPage-1)*perPage;
    display(filtered.slice(start,start+perPage));

    document.getElementById("page-info").innerText=
        "Page "+currentPage+" of "+totalPages;

    document.getElementById("prev-page").disabled=currentPage===1;
    document.getElementById("next-page").disabled=currentPage===totalPages;
}

document.getElementById("search").addEventListener("input",()=>{currentPage=1;render();});
document.getElementById("prev-page").addEventListener("click",()=>{if(currentPage>1)currentPage--;render();});
document.getElementById("next-page").addEventListener("click",()=>{currentPage++;render();});

function jumpToPage(){
 let p=parseInt(document.getElementById("jumpPage").value);
 if(!isNaN(p)&&p>0){currentPage=p;render();}
}

function loadData(){
    statusEl.innerText="Fetching from SheetDB...";
    fetch(SHEETDB_BASE)
    .then(res=>res.json())
    .then(data=>{
        items=data.map(cleanKeys);
        statusEl.innerText="Loaded "+items.length+" records.";
        render();
    })
    .catch(err=>{
        statusEl.innerText="Offline mode: Using sample data.";
        items=mockData;render();
    });
}
loadData();

document.getElementById('btn-refresh').addEventListener('click',loadData);

/* ===========================
   ROBUST LOCAL SCANNER LOADER
   - Tries ./html5-qrcode.min.js first
   - Falls back to raw.githubusercontent.com for your repo
   =========================== */

let html5QrcodeLoaded=false;
let qrScanner=null;

const scanBeep = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU3LjgzLjEwMAAAAAAAAAAAAAAA//tQxAADBjQACgAAAAEAAwBCAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==");
// small short beep (tiny base64 mp3)

function injectScriptText(code){
  return new Promise((resolve,reject)=>{
    try{
      const s = document.createElement('script');
      s.type = "text/javascript";
      s.text = code;
      document.head.appendChild(s);
      html5QrcodeLoaded = true;
      resolve();
    }catch(e){
      reject(e);
    }
  });
}

function tryLoadLocalScript(){
  return new Promise((resolve,reject)=>{
    // Try relative local file first
    const s = document.createElement('script');
    s.src = "./html5-qrcode.min.js";
    s.onload = () => { html5QrcodeLoaded = true; resolve(); };
    s.onerror = () => reject(new Error("local-failed"));
    document.head.appendChild(s);
  });
}

function tryFetchRawGithub(){
  return new Promise((resolve,reject)=>{
    // Attempt to fetch raw file from your repo automatically
    try {
      const originPath = window.location.pathname || "/";
      // attempt best-guess repo path from current URL
      // e.g. https://username.github.io/reponame/... -> /reponame/ present
      let repoPrefix = "";
      const parts = originPath.split("/").filter(Boolean);
      if(parts.length>0){
        // assume first part is repo name when served as user.github.io/repo
        repoPrefix = "/" + parts[0];
      }

      // Build raw.githubusercontent.com URL using GitHub username/repo from window.location.host + repoPrefix
      // This is a best-effort fallback: if repo is different, user can upload the local file.
      const hostname = window.location.hostname; // e.g. azarandu.github.io
      let rawUrl = null;
      if(hostname.endsWith("github.io") && parts.length>0){
        const username = hostname.split(".")[0];
        const repo = parts[0];
        rawUrl = "https://raw.githubusercontent.com/" + username + "/" + repo + "/main/html5-qrcode.min.js";
      } else {
        // generic fallback to raw file at mebjas CDN (only used if the user wants it)
        rawUrl = "https://raw.githubusercontent.com/mebjas/html5-qrcode/master/dist/html5-qrcode.min.js";
      }

      fetch(rawUrl).then(resp=>{
          if(!resp.ok) throw new Error("raw-fetch-failed");
          return resp.text();
      }).then(txt=>{
          if(!txt || txt.length < 200) throw new Error("raw-too-small");
          return injectScriptText(txt);
      }).then(()=>resolve()).catch(err=>reject(err));
    } catch(e){
      reject(e);
    }
  });
}

async function loadHtml5QrcodeScript(){
  if(html5QrcodeLoaded) return;
  // First, try exact local file (fast, reliable if present in repo root)
  try {
    await tryLoadLocalScript();
    return;
  } catch(e){
    // ignore and try raw
  }
  // Try fetching raw from GitHub repo (your repo)
  try {
    await tryFetchRawGithub();
    return;
  } catch(e){
    // final fallback: try to load from unpkg (may be blocked on GitHub Pages)
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js";
      s.onload=()=>{ html5QrcodeLoaded=true; resolve(); };
      s.onerror=()=>reject(new Error("All scanner load attempts failed."));
      document.head.appendChild(s);
    });
  }
}

/* ===========================
   SCANNER: OPEN / CLOSE / AUTO-CLOSE ON SUCCESS
   =========================== */

const qrBackdrop = document.getElementById("qr-backdrop");
const qrReader = document.getElementById("qr-reader");
const scanButton = document.getElementById("btn-scan");
const qrCloseButton = document.getElementById("qr-close");

scanButton.addEventListener("click", openQR);
qrCloseButton.addEventListener("click", closeQR);

let scanLock = false;

function safeClearScanner(){
  if(qrScanner){
    // stop and clear existing scanner safely
    try{
      qrScanner.stop().then(()=>{ try{ qrScanner.clear(); }catch(e){} }).catch(()=>{});
    }catch(e){}
    qrScanner = null;
  }
}

async function openQR(){
  // Reset and show modal
  scanLock = false;
  qrReader.innerHTML = ""; // clear previous
  qrBackdrop.style.display = "flex";
  qrBackdrop.setAttribute("aria-hidden","false");

  // wait next animation frame + short delay so element is visible and has dimensions
  await new Promise(r => requestAnimationFrame(()=>setTimeout(r, 220)));

  try{
    await loadHtml5QrcodeScript();
  }catch(e){
    alert("Scanner library failed to load: "+ (e && e.message ? e.message : e));
    qrBackdrop.style.display = "none";
    qrBackdrop.setAttribute("aria-hidden","true");
    return;
  }

  // If a previous scanner/stream exists, clear it first
  safeClearScanner();

  try{
    // Create instance
    qrScanner = new Html5Qrcode("qr-reader");

    const config = {
      fps: 15,
      qrbox: 250,
      aspectRatio: 1.777,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true },
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39
      ]
    };

    // Start with camera constraints friendly for autofocus and environment camera
    const cameraConstraints = {
      facingMode: { ideal: "environment" }
    };

    // Try to include some advanced autofocus hints when supported
    // Html5Qrcode's start accepts a constraints-like object; the library will apply them if supported.
    const startConstraints = {
      ...cameraConstraints,
      // note: focusMode and advanced are best-effort; some browsers ignore them.
      focusMode: "continuous",
      advanced: [{ focusMode: "continuous" }]
    };

    await qrScanner.start(
      startConstraints,
      config,
      (decodedText, decodedResult) => {
        if (scanLock) return;
        scanLock = true;
        try { scanBeep.play(); } catch(e){ /* ignore audio play errors */ }

        // populate search and show result
        document.getElementById("search").value = decodedText;
        currentPage = 1;
        render();

        // close scanner and clear resources
        closeQR();
      },
      (errorMessage) => {
        // We intentionally ignore frequent scan errors, they are normal during scanning
      }
    );

  }catch(err){
    // typical errors: NotFoundError, NotReadableError, OverconstrainedError
    console.error("Failed to start scanner:", err);
    alert("Camera failed to start: " + (err && err.message ? err.message : err));
    qrBackdrop.style.display = "none";
    qrBackdrop.setAttribute("aria-hidden","true");

    // ensure any partial streams are stopped
    safeClearScanner();
  }
}

function closeQR(){
  qrBackdrop.style.display = "none";
  qrBackdrop.setAttribute("aria-hidden","true");

  // stop & clear the scanner safely
  safeClearScanner();
}

/* make sure we free camera when page is unloaded */
window.addEventListener("pagehide", ()=>{ safeClearScanner(); });
window.addEventListener("beforeunload", ()=>{ safeClearScanner(); });
</script>
</body>
</html>